<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tic-Tac-Toe</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

```
:root {
  --x: #E05C5C;
  --o: #4A90D9;
  --bg: #F5F2EE;
  --surface: #FFFFFF;
  --border: #E0DAD4;
  --text: #1A1614;
  --muted: #8A837D;
  --shadow: 0 2px 16px rgba(0,0,0,0.08);
}

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 24px;
}

/* Subtle grid background */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image:
    linear-gradient(var(--border) 1px, transparent 1px),
    linear-gradient(90deg, var(--border) 1px, transparent 1px);
  background-size: 40px 40px;
  opacity: 0.5;
  pointer-events: none;
  z-index: 0;
}

.app {
  position: relative;
  z-index: 1;
  width: 100%;
  max-width: 420px;
}

header {
  text-align: center;
  margin-bottom: 32px;
}

header h1 {
  font-family: 'Bebas Neue', sans-serif;
  font-size: clamp(48px, 10vw, 72px);
  letter-spacing: 4px;
  line-height: 1;
  color: var(--text);
}

header h1 span.x { color: var(--x); }
header h1 span.o { color: var(--o); }

.card {
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: 20px;
  padding: 32px;
  box-shadow: var(--shadow);
}

/* STATUS BAR */
.status {
  text-align: center;
  margin-bottom: 28px;
  min-height: 52px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.status-pill {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  padding: 10px 20px;
  border-radius: 100px;
  font-size: 15px;
  font-weight: 500;
  border: 1.5px solid var(--border);
  background: var(--bg);
  transition: all 0.3s ease;
}

.status-pill.your-turn {
  border-color: currentColor;
  background: color-mix(in srgb, currentColor 8%, white);
}

.status-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: currentColor;
  animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.5; transform: scale(0.75); }
}

/* BOARD */
.board {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  margin-bottom: 0;
}

.cell {
  aspect-ratio: 1;
  background: var(--bg);
  border: 1.5px solid var(--border);
  border-radius: 14px;
  font-family: 'Bebas Neue', sans-serif;
  font-size: clamp(32px, 8vw, 52px);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.15s ease;
  position: relative;
  overflow: hidden;
  user-select: none;
}

.cell:hover:not(.filled):not(.disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.1);
  background: white;
}

.cell:active:not(.filled):not(.disabled) {
  transform: translateY(0);
}

.cell.filled { cursor: default; }
.cell.disabled { cursor: not-allowed; }

.cell .mark {
  display: inline-block;
  transform: scale(0);
  animation: pop-in 0.25s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
}

@keyframes pop-in {
  to { transform: scale(1); }
}

.cell.x .mark { color: var(--x); }
.cell.o .mark { color: var(--o); }

.cell.winner-cell {
  background: color-mix(in srgb, currentColor 12%, white);
  border-color: currentColor;
}
.cell.winner-cell.x { color: var(--x); }
.cell.winner-cell.o { color: var(--o); }

/* LOBBY */
.lobby {
  text-align: center;
}

.waiting-icon {
  font-size: 48px;
  margin-bottom: 16px;
  display: block;
  animation: spin 3s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.lobby h2 {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 28px;
  letter-spacing: 2px;
  margin-bottom: 8px;
}

.lobby p {
  color: var(--muted);
  font-size: 14px;
  margin-bottom: 24px;
}

.share-box {
  background: var(--bg);
  border: 1.5px solid var(--border);
  border-radius: 12px;
  padding: 12px 14px;
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 12px;
}

.share-url {
  flex: 1;
  font-size: 13px;
  color: var(--muted);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-family: monospace;
}

.btn-copy {
  background: var(--text);
  color: white;
  border: none;
  border-radius: 8px;
  padding: 8px 14px;
  font-family: 'DM Sans', sans-serif;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  white-space: nowrap;
  transition: opacity 0.2s;
  flex-shrink: 0;
}
.btn-copy:hover { opacity: 0.8; }
.btn-copy.copied { background: #3BAB6F; }

/* RESULT SCREEN */
.result {
  text-align: center;
  padding: 8px 0;
}

.result-emoji {
  font-size: 56px;
  margin-bottom: 12px;
  display: block;
}

.result h2 {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 40px;
  letter-spacing: 3px;
  margin-bottom: 8px;
}

.result p {
  color: var(--muted);
  font-size: 14px;
}

.role-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  margin-top: 20px;
  font-size: 13px;
  color: var(--muted);
  background: var(--bg);
  border: 1.5px solid var(--border);
  padding: 6px 14px;
  border-radius: 100px;
}

.role-badge strong {
  font-size: 15px;
}

.x-color { color: var(--x); }
.o-color { color: var(--o); }

/* ERROR */
.error-screen {
  text-align: center;
}

.error-screen h2 {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 32px;
  letter-spacing: 2px;
  margin-bottom: 8px;
}

.error-screen p { color: var(--muted); font-size: 14px; }

/* Connecting */
.connecting {
  text-align: center;
  color: var(--muted);
  font-size: 15px;
  padding: 20px;
}

/* Responsive */
@media (max-width: 440px) {
  .card { padding: 24px 18px; border-radius: 16px; }
}
```

  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>TIC<span class="x">-</span>TAC<span class="o">-</span>TOE</h1>
    </header>
    <div class="card" id="root">
      <div class="connecting">Connecting‚Ä¶</div>
    </div>
  </div>

  <script>
    const root = document.getElementById('root');

    // Extract sessionId from URL
    const pathParts = window.location.pathname.split('/');
    const sessionId = pathParts[pathParts.length - 1];

    let myRole = null;
    let gameBoard = Array(9).fill(null);
    let gameOver = false;
    let shareUrl = '';

    // WebSocket setup
    const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
    const ws = new WebSocket(`${protocol}://${location.host}`);

    ws.addEventListener('open', () => {
      ws.send(JSON.stringify({
        event: 'join',
        data: { sessionId, origin: location.origin }
      }));
    });

    ws.addEventListener('message', (e) => {
      const { event, data } = JSON.parse(e.data);
      switch (event) {
        case 'waiting':   handleWaiting(data); break;
        case 'start':     handleStart(data); break;
        case 'update':    handleUpdate(data); break;
        case 'end':       handleEnd(data); break;
        case 'opponent_left': handleOpponentLeft(); break;
        case 'error':     handleError(data); break;
      }
    });

    ws.addEventListener('close', () => {
      if (!gameOver) {
        root.innerHTML = `<div class="error-screen">
          <h2>Disconnected</h2>
          <p>Connection lost. Please refresh the page.</p>
        </div>`;
      }
    });

    function handleWaiting(data) {
      shareUrl = data.shareUrl;
      renderLobby(shareUrl);
    }

    function handleStart(data) {
      myRole = data.yourRole;
      gameBoard = data.board;
      renderGame(data.board, data.currentTurn);
    }

    function handleUpdate(data) {
      gameBoard = data.board;
      renderGame(data.board, data.currentTurn);
    }

    function handleEnd(data) {
      gameOver = true;
      renderGame(data.board, null, data.winner, data.winLine || []);
      setTimeout(() => renderResult(data.winner), 800);
    }

    function handleOpponentLeft() {
      gameOver = true;
      root.innerHTML = `<div class="error-screen">
        <span style="font-size:48px;display:block;margin-bottom:16px">üëã</span>
        <h2>Opponent Left</h2>
        <p>Your opponent disconnected. The game has ended.</p>
      </div>`;
    }

    function handleError(data) {
      if (data.message === 'Session not found.' || data.message === 'This game is already full.') {
        root.innerHTML = `<div class="error-screen">
          <span style="font-size:48px;display:block;margin-bottom:16px">‚ùå</span>
          <h2>Oops!</h2>
          <p>${data.message}</p>
        </div>`;
      }
    }

    // --- RENDERS ---

    function renderLobby(url) {
      root.innerHTML = `
        <div class="lobby">
          <span class="waiting-icon">‚è≥</span>
          <h2>Waiting for Opponent</h2>
          <p>Share this link with a friend to start playing.</p>
          <div class="share-box">
            <span class="share-url" id="share-url-text">${url}</span>
            <button class="btn-copy" id="copy-btn">Copy Link</button>
          </div>
          <p style="font-size:12px;color:var(--muted)">You are <strong class="x-color">X</strong> ‚Äî you go first!</p>
        </div>
      `;
      document.getElementById('copy-btn').addEventListener('click', () => {
        navigator.clipboard.writeText(url).then(() => {
          const btn = document.getElementById('copy-btn');
          btn.textContent = 'Copied!';
          btn.classList.add('copied');
          setTimeout(() => {
            btn.textContent = 'Copy Link';
            btn.classList.remove('copied');
          }, 2000);
        });
      });
    }

    function renderGame(board, currentTurn, winner = null, winLine = []) {
      const isMyTurn = currentTurn === myRole;
      const statusHtml = winner
        ? ''
        : `<div class="status">
            <div class="status-pill ${isMyTurn ? 'your-turn' : ''}" style="color:${currentTurn === 'X' ? 'var(--x)' : 'var(--o)'}">
              ${isMyTurn ? '<div class="status-dot"></div>' : ''}
              ${isMyTurn ? 'Your turn' : "Opponent's turn"}
            </div>
           </div>`;

      const cellsHtml = board.map((cell, i) => {
        const isWinnerCell = winLine.includes(i);
        const cls = [
          'cell',
          cell ? cell.toLowerCase() : '',
          cell ? 'filled' : '',
          (!cell && (!isMyTurn || winner)) ? 'disabled' : '',
          isWinnerCell ? 'winner-cell' : '',
        ].filter(Boolean).join(' ');

        return `<div class="${cls}" data-index="${i}">
          ${cell ? `<span class="mark">${cell}</span>` : ''}
        </div>`;
      }).join('');

      root.innerHTML = `
        ${statusHtml}
        <div class="board" id="board">${cellsHtml}</div>
        <div style="display:flex;justify-content:center;margin-top:20px">
          <div class="role-badge">Playing as <strong class="${myRole === 'X' ? 'x-color' : 'o-color'}">${myRole}</strong></div>
        </div>
      `;

      if (!winner) {
        document.getElementById('board').addEventListener('click', (e) => {
          const cell = e.target.closest('.cell');
          if (!cell || cell.classList.contains('filled') || cell.classList.contains('disabled')) return;
          const index = parseInt(cell.dataset.index);
          ws.send(JSON.stringify({ event: 'move', data: { sessionId, cellIndex: index } }));
        });
      }
    }

    function renderResult(winner) {
      let emoji, headline, subtext;
      if (winner === 'draw') {
        emoji = 'ü§ù'; headline = "It's a Draw!"; subtext = "Perfectly matched.";
      } else if (winner === myRole) {
        emoji = 'üèÜ'; headline = 'You Win!'; subtext = 'Congratulations, well played!';
      } else {
        emoji = 'üòî'; headline = 'You Lose'; subtext = 'Better luck next time!';
      }

      const color = winner === 'X' ? 'var(--x)' : winner === 'O' ? 'var(--o)' : 'var(--text)';

      root.innerHTML = `
        <div class="result">
          <span class="result-emoji">${emoji}</span>
          <h2 style="color:${color}">${headline}</h2>
          <p>${subtext}</p>
          <div class="role-badge" style="margin-top:24px">
            You played as <strong class="${myRole === 'X' ? 'x-color' : 'o-color'}" style="margin-left:4px">${myRole}</strong>
          </div>
          <p style="font-size:12px;color:var(--muted);margin-top:24px">
            <a href="/" style="color:inherit;text-decoration:underline">Start a new game</a>
          </p>
        </div>
      `;
    }
  </script>

</body>
</html>